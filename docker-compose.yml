services:
  activemq:
    image: rmohr/activemq:latest
    profiles: ["master"]
    ports:
      - "61616:61616"
      - "8161:8161"
    networks:
      - cluster_net
    restart: unless-stopped

  nginx:
    image: nginx:latest
    container_name: stage3-nginx
    profiles: ["master"]
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - cluster_net
    restart: unless-stopped

  crawler:
    build:
      context: .
      dockerfile: ingestion-service/Dockerfile
    profiles: ["node"]
    ports:
      - "8080:8080"
    environment:
      - server.port=8080
      - BROKER_URL=tcp://${MASTER_NODE_IP:-localhost}:61616
      - MASTER_NODE_IP=${MASTER_NODE_IP:-localhost}
      - CURRENT_NODE_IP=${CURRENT_NODE_IP:-localhost}
      - CLUSTER_NODES_LIST=${CLUSTER_NODES_LIST:-localhost}
      - DATA_VOLUME_PATH=/datalake
      - ingestion.async.enabled=${INGESTION_ASYNC_ENABLED:-true}
      - ingestion.async.workers=${INGESTION_ASYNC_WORKERS:-4}
      - datalake.replication.enabled=${DATALAKE_REPLICATION_ENABLED:-true}
      - datalake.replication.port=8080
      - datalake.replication.endpoint=/api/datalake/store
    volumes:
      - ${HOST_DATA_VOLUME_PATH:-./datalake}:/datalake
    networks:
      - cluster_net
    restart: unless-stopped

  indexer:
    build:
      context: .
      dockerfile: indexing-service/Dockerfile
    profiles: ["node"]
    ports:
      - "8081:8081"
      - "5701:5701"
    environment:
      - server.port=8081
      - hazelcast.cluster.name=${HAZELCAST_CLUSTER_NAME:-search-cluster}
      - hazelcast.port=5701
      - JAVA_TOOL_OPTIONS=--add-modules java.se --add-exports java.base/jdk.internal.ref=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.nio=ALL-UNNAMED --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.management/sun.management=ALL-UNNAMED --add-opens jdk.management/com.sun.management.internal=ALL-UNNAMED
      - BROKER_URL=tcp://${MASTER_NODE_IP:-localhost}:61616
      - MASTER_NODE_IP=${MASTER_NODE_IP:-localhost}
      - CURRENT_NODE_IP=${CURRENT_NODE_IP:-localhost}
      - CLUSTER_NODES_LIST=${CLUSTER_NODES_LIST:-localhost}
      - DATA_VOLUME_PATH=/datalake
    volumes:
      - ${HOST_DATA_VOLUME_PATH:-./datalake}:/datalake
    networks:
      - cluster_net
    restart: unless-stopped

  search:
    build:
      context: .
      dockerfile: search-service/Dockerfile
    profiles: ["node"]
    ports:
      - "8082:8082"
      - "5702:5702"
    environment:
      - server.port=8082
      - hazelcast.cluster.name=${HAZELCAST_CLUSTER_NAME:-search-cluster}
      - hazelcast.port=5702
      - JAVA_TOOL_OPTIONS=--add-modules java.se --add-exports java.base/jdk.internal.ref=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.nio=ALL-UNNAMED --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.management/sun.management=ALL-UNNAMED --add-opens jdk.management/com.sun.management.internal=ALL-UNNAMED
      - CURRENT_NODE_IP=${CURRENT_NODE_IP:-localhost}
      - CLUSTER_NODES_LIST=${CLUSTER_NODES_LIST:-localhost}
    networks:
      - cluster_net
    restart: unless-stopped

networks:
  cluster_net:
    driver: bridge