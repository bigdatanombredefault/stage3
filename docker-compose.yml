services:
  activemq:
    image: rmohr/activemq:latest
    profiles: ["master"]
    ports:
      - "61616:61616"
      - "8161:8161"
    networks:
      - cluster_net
    restart: unless-stopped

  nginx:
    image: nginx:latest
    container_name: search_load_balancer
    profiles: ["master"]
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - cluster_net
    restart: unless-stopped

  # NOTE: Indexer and Search both run Hazelcast with a fixed port (5701, no auto-increment).
  # Do not run both on the same physical host.
  # To avoid accidental port collisions, the shared "worker" profile is only used for crawler nodes.

  crawler:
    build:
      context: .
      dockerfile: ingestion-service/Dockerfile
    profiles: ["crawler", "worker"]
    ports:
      - "8080:8080"
    environment:
      - server.port=8080
      - BROKER_URL=tcp://${MASTER_NODE_IP:-localhost}:61616
      - MASTER_NODE_IP=${MASTER_NODE_IP:-localhost}
      - CURRENT_NODE_IP=${CURRENT_NODE_IP:-localhost}
      - CLUSTER_NODES_LIST=${CLUSTER_NODES_LIST:-localhost}
      - DATA_VOLUME_PATH=/datalake
      - datalake.replication.enabled=${DATALAKE_REPLICATION_ENABLED:-true}
      - datalake.replication.port=8080
      - datalake.replication.endpoint=/api/datalake/store
    volumes:
      - ${HOST_DATA_VOLUME_PATH:-./datalake}:/datalake
    networks:
      - cluster_net
    restart: unless-stopped

  indexer:
    build:
      context: .
      dockerfile: indexing-service/Dockerfile
    profiles: ["indexer"]
    ports:
      - "8081:8081"
      - "5701:5701"
    environment:
      - server.port=8081
      - BROKER_URL=tcp://${MASTER_NODE_IP:-localhost}:61616
      - MASTER_NODE_IP=${MASTER_NODE_IP:-localhost}
      - CURRENT_NODE_IP=${CURRENT_NODE_IP:-localhost}
      - CLUSTER_NODES_LIST=${CLUSTER_NODES_LIST:-localhost}
      - DATA_VOLUME_PATH=/datalake
    volumes:
      - ${HOST_DATA_VOLUME_PATH:-./datalake}:/datalake
    networks:
      - cluster_net
    restart: unless-stopped

  search:
    build:
      context: .
      dockerfile: search-service/Dockerfile
    profiles: ["search"]
    ports:
      - "8082:8082"
      - "5701:5701"
    environment:
      - server.port=8082
      - CURRENT_NODE_IP=${CURRENT_NODE_IP:-localhost}
      - CLUSTER_NODES_LIST=${CLUSTER_NODES_LIST:-localhost}
    networks:
      - cluster_net
    restart: unless-stopped

networks:
  cluster_net:
    driver: bridge